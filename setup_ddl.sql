set advanced_mode=1;
set enable_subresult_cache=false; -- always good for benchmarking
set enable_vector_search_index_creation=1; -- allows you to created vector indexes
set enable_vector_search_tvf=1; -- allows you to use the vector search TVF
set enable_granule_pruning_by_tablet_id_and_row_number=1; -- optimization, should be enabled already per default, just to make sure
set enable_udf_ddl=true;

CREATE DATABASE IF NOT EXISTS data_chat_demo;
CREATE ENGINE IF NOT EXISTS data_chat_engine;

USE DATABASE data_chat_demo;
USE ENGINE data_chat_engine;  

DROP TABLE IF EXISTS ext_pdf_content;
CREATE EXTERNAL TABLE ext_pdf_content
(
    filename TEXT,
    page_num INTEGER,
    page_content TEXT
)
URL = 's3://firebolt-publishing-public/faa-pdfs/chunked/'
OBJECT_PATTERN = '*.parquet'
TYPE = (PARQUET);

--SELECT * FROM ext_pdf_content LIMIT 10;

DROP INDEX IF EXISTS pdf_semantic_index;
DROP TABLE IF EXISTS pdf_semantic_knowledge;
CREATE TABLE pdf_semantic_knowledge
(
  embedding ARRAY(FLOAT NOT NULL) NOT NULL,
  file_name TEXT,
  page_number INTEGER,
  page_content TEXT
)
PRIMARY INDEX file_name, page_number;

CREATE INDEX pdf_semantic_index ON pdf_semantic_knowledge 
       USING HNSW( embedding vector_cosine_ops) WITH ( dimension = 256);


DROP LOCATION IF EXISTS llm_api;
CREATE LOCATION IF NOT EXISTS llm_api WITH
  SOURCE = AMAZON_BEDROCK
  CREDENTIALS = 
    (  

    AWS_ACCESS_KEY_ID='<fill me in>'
    AWS_SECRET_ACCESS_KEY='<fill me in>'
    AWS_SESSION_TOKEN='<fill me in>'
)
  DESCRIPTION = 'Testing embeddings calc on Bedrock'
;




INSERT INTO pdf_semantic_knowledge (embedding, file_name, page_number, page_content)
WITH
  content_with_embedding AS (
    SELECT pc.filename, pc.page_num, pc.page_content,
      AI_EMBED_TEXT (
        MODEL => 'amazon.titan-embed-text-v2:0',
        INPUT_TEXT => pc.page_content,   -- chunked PDF values
        DIMENSIONS => 256,
        LOCATION =>'llm_api'
      ) AS embedding
    FROM ext_pdf_content pc
)
SELECT 
  embedding,
  filename, page_num, page_content
  FROM content_with_embedding
;

-- test converting user query into embedding
SELECT AI_EMBED_TEXT (
            MODEL => 'amazon.titan-embed-text-v2:0',
            INPUT_TEXT => 'What FAA regulations have affects flight delays?',   -- chunked PDF values
            DIMENSIONS => 256,
            LOCATION =>'llm_api'
          );


-- test vector search
SELECT embedding, page_content, 
       vector_cosine_distance(embedding, 
          [-0.059915121644735336, 0.008078846149146557, 0.02552419900894165, -0.012905209325253963, -0.07958842068910599, 0.03996485471725464, 0.03741852194070816, -0.12977713346481323, 0.009347524493932724, 0.10919907689094543, 0.08342905342578888, 0.009793356992304325, 0.00018102600006386638, 0.027875011786818504, -0.006088308524340391, -0.020746365189552307, 0.07895800471305847, -0.03502329811453819, 0.04205750301480293, 0.0020571136847138405, 0.09788569808006287, 0.08489371091127396, 0.03562472015619278, -0.015279493294656277, -0.0347525030374527, -0.01815645955502987, -0.053350307047367096, -0.07230417430400848, 0.044018495827913284, 0.030313625931739807, -0.04129188135266304, 0.06627459079027176, 0.05534308776259422, -0.20215068757534027, -0.006002283655107021, 0.026655705645680428, 0.10108133405447006, 0.046852823346853256, 0.07727865874767303, -0.012658355757594109, 0.08823297172784805, 0.08644066751003265, -0.0031937623862177134, 0.0037372142542153597, -0.04461019113659859, 0.004171078559011221, -0.01132684201002121, 0.026218848302960396, -0.03642288222908974, 0.011018648743629456, 0.0169745534658432, -0.13383956253528595, -0.07404562085866928, 0.12644891440868378, 0.02692350372672081, 0.031015288084745407, 0.0015170278493314981, 0.08474485576152802, 0.047254517674446106, -0.05895164608955383, -0.06135733798146248, 0.0398496612906456, -0.08764389157295227, -0.014811218716204166, 0.03138931095600128, 0.024769144132733345, -0.0038714411202818155, -0.040737584233284, 0.012728671543300152, 0.07328411191701889, -0.06170742213726044, 0.007462460082024336, 0.015150829218327999, 0.035355981439352036, -0.10393136739730835, -0.02214842662215233, 0.04524153843522072, 0.0168309286236763, -0.03739982098340988, -0.010860064066946507, -0.020816495642066002, -0.009206892922520638, 0.08376865833997726, 0.05218486115336418, -0.014634680934250355, -0.1977940946817398, -0.01789613999426365, -0.028425944969058037, -0.09312067180871964, -0.014443556778132915, -0.0023585744202136993, 0.03178165853023529, 0.08773926645517349, -0.04710865393280983, 0.04887888953089714, -0.00816262699663639, -0.04660896211862564, -0.08477964252233505, 0.06285342574119568, -0.10221461206674576, -0.07379277795553207, 0.015167707577347755, 0.06111797317862511, -0.061584748327732086, 0.03781498596072197, 0.022402344271540642, 0.012357642874121666, 0.019582226872444153, 0.058289628475904465, 0.07747314870357513, 0.022637227550148964, -0.06044173613190651, -0.07831843197345734, -0.008584522642195225, 0.04177361726760864, 0.006668414454907179, -0.009506109170615673, -0.0762673020362854, 0.06678064167499542, -0.052745889872312546, -0.017264792695641518, 0.024481896311044693, 0.01282442081719637, -0.03272194787859917, 0.055735062807798386, -0.2111271768808365, 0.11953999847173691, 0.10637147724628448, -0.051569968461990356, 0.053668223321437836, -0.04259646683931351, 0.016693292185664177, 0.1330915093421936, -0.025550099089741707, -0.05402204766869545, 0.14069759845733643, -0.010742714628577232, -0.007414586376398802, -0.010857071727514267, -0.06680158525705338, -0.09182432293891907, 0.07848300039768219, 0.07308588176965714, 0.001750416704453528, 0.043368447571992874, 0.020175423473119736, 0.02171115204691887, -0.0007689864723943174, -0.04080266132950783, -0.0005535506061278284, -0.06279657036066055, 0.07194362580776215, 0.048281580209732056, -0.032638538628816605, -0.02352776937186718, -0.028238002210855484, -0.05980440974235535, -0.11709091812372208, 0.016018088907003403, 0.06994485855102539, 0.1590595841407776, 0.00206403317861259, 0.06671331822872162, -0.04260993376374245, 0.019893411546945572, -0.09605449438095093, 0.011099436320364475, -0.0009096182766370475, -0.08261368423700333, 0.045286424458026886, -0.045367494225502014, -0.1648009866476059, -0.1290939897298813, -0.10145629197359085, -0.0007091432344168425, 0.04409778490662575, -0.035208810120821, 0.161698117852211, -0.05398464575409889, 0.057898398488759995, -0.11520209908485413, 0.08491764962673187, -0.02687263861298561, -0.08500666916370392, -0.045857928693294525, 0.008979488164186478, 0.0036354807671159506, -0.006084100808948278, -0.011928267776966095, -0.07575564086437225, 0.04710332304239273, -0.0044876872561872005, -0.03744096681475639, 0.04803229868412018, 0.022893056273460388, 0.03815459832549095, 0.07969033718109131, -0.07410696148872375, 0.056982796639204025, 0.11321980506181717, -0.01095123216509819, 0.025400491431355476, -0.05580538138747215, 0.012483312748372555, -0.011376961134374142, -0.0068026878871023655, 0.004903411027044058, 0.015429849736392498, 0.049535300582647324, -0.039502568542957306, -0.04969986528158188, -0.010050683282315731, -0.01933238096535206, -0.021974463015794754, -0.11043483763933182, -0.06486939638853073, 0.06382288783788681, 0.06134537607431412, 0.006464947015047073, -0.07057620584964752, -0.019604666158556938, 0.04850337654352188, 0.07953473925590515, -0.13069778680801392, -0.08097472786903381, -0.035139989107847214, -0.09215270727872849, 0.004090290050953627, 0.07554320245981216, 0.11321456730365753, -0.020489415153861046, -0.004201000090688467, 0.03860342130064964, 0.0529588982462883, 0.04659923538565636, 0.01077478751540184, -0.0702141523361206, -0.033120278269052505, -0.0030482683796435595, -0.010406751185655594, -0.04371554031968117, 0.02922447770833969, -0.0257999449968338, 0.03400520980358124, -0.006668788380920887, 0.042731113731861115, -0.07517815381288528, -0.019018203020095825, -0.1864369660615921, -0.0712374672293663, -0.06218991428613663, -0.01968321204185486, -0.00255231698974967, -0.01879379153251648, -0.004883213900029659, 0.010086589492857456]) AS distance
     FROM
        vector_search(
          INDEX pdf_semantic_index,
          [-0.059915121644735336, 0.008078846149146557, 0.02552419900894165, -0.012905209325253963, -0.07958842068910599, 0.03996485471725464, 0.03741852194070816, -0.12977713346481323, 0.009347524493932724, 0.10919907689094543, 0.08342905342578888, 0.009793356992304325, 0.00018102600006386638, 0.027875011786818504, -0.006088308524340391, -0.020746365189552307, 0.07895800471305847, -0.03502329811453819, 0.04205750301480293, 0.0020571136847138405, 0.09788569808006287, 0.08489371091127396, 0.03562472015619278, -0.015279493294656277, -0.0347525030374527, -0.01815645955502987, -0.053350307047367096, -0.07230417430400848, 0.044018495827913284, 0.030313625931739807, -0.04129188135266304, 0.06627459079027176, 0.05534308776259422, -0.20215068757534027, -0.006002283655107021, 0.026655705645680428, 0.10108133405447006, 0.046852823346853256, 0.07727865874767303, -0.012658355757594109, 0.08823297172784805, 0.08644066751003265, -0.0031937623862177134, 0.0037372142542153597, -0.04461019113659859, 0.004171078559011221, -0.01132684201002121, 0.026218848302960396, -0.03642288222908974, 0.011018648743629456, 0.0169745534658432, -0.13383956253528595, -0.07404562085866928, 0.12644891440868378, 0.02692350372672081, 0.031015288084745407, 0.0015170278493314981, 0.08474485576152802, 0.047254517674446106, -0.05895164608955383, -0.06135733798146248, 0.0398496612906456, -0.08764389157295227, -0.014811218716204166, 0.03138931095600128, 0.024769144132733345, -0.0038714411202818155, -0.040737584233284, 0.012728671543300152, 0.07328411191701889, -0.06170742213726044, 0.007462460082024336, 0.015150829218327999, 0.035355981439352036, -0.10393136739730835, -0.02214842662215233, 0.04524153843522072, 0.0168309286236763, -0.03739982098340988, -0.010860064066946507, -0.020816495642066002, -0.009206892922520638, 0.08376865833997726, 0.05218486115336418, -0.014634680934250355, -0.1977940946817398, -0.01789613999426365, -0.028425944969058037, -0.09312067180871964, -0.014443556778132915, -0.0023585744202136993, 0.03178165853023529, 0.08773926645517349, -0.04710865393280983, 0.04887888953089714, -0.00816262699663639, -0.04660896211862564, -0.08477964252233505, 0.06285342574119568, -0.10221461206674576, -0.07379277795553207, 0.015167707577347755, 0.06111797317862511, -0.061584748327732086, 0.03781498596072197, 0.022402344271540642, 0.012357642874121666, 0.019582226872444153, 0.058289628475904465, 0.07747314870357513, 0.022637227550148964, -0.06044173613190651, -0.07831843197345734, -0.008584522642195225, 0.04177361726760864, 0.006668414454907179, -0.009506109170615673, -0.0762673020362854, 0.06678064167499542, -0.052745889872312546, -0.017264792695641518, 0.024481896311044693, 0.01282442081719637, -0.03272194787859917, 0.055735062807798386, -0.2111271768808365, 0.11953999847173691, 0.10637147724628448, -0.051569968461990356, 0.053668223321437836, -0.04259646683931351, 0.016693292185664177, 0.1330915093421936, -0.025550099089741707, -0.05402204766869545, 0.14069759845733643, -0.010742714628577232, -0.007414586376398802, -0.010857071727514267, -0.06680158525705338, -0.09182432293891907, 0.07848300039768219, 0.07308588176965714, 0.001750416704453528, 0.043368447571992874, 0.020175423473119736, 0.02171115204691887, -0.0007689864723943174, -0.04080266132950783, -0.0005535506061278284, -0.06279657036066055, 0.07194362580776215, 0.048281580209732056, -0.032638538628816605, -0.02352776937186718, -0.028238002210855484, -0.05980440974235535, -0.11709091812372208, 0.016018088907003403, 0.06994485855102539, 0.1590595841407776, 0.00206403317861259, 0.06671331822872162, -0.04260993376374245, 0.019893411546945572, -0.09605449438095093, 0.011099436320364475, -0.0009096182766370475, -0.08261368423700333, 0.045286424458026886, -0.045367494225502014, -0.1648009866476059, -0.1290939897298813, -0.10145629197359085, -0.0007091432344168425, 0.04409778490662575, -0.035208810120821, 0.161698117852211, -0.05398464575409889, 0.057898398488759995, -0.11520209908485413, 0.08491764962673187, -0.02687263861298561, -0.08500666916370392, -0.045857928693294525, 0.008979488164186478, 0.0036354807671159506, -0.006084100808948278, -0.011928267776966095, -0.07575564086437225, 0.04710332304239273, -0.0044876872561872005, -0.03744096681475639, 0.04803229868412018, 0.022893056273460388, 0.03815459832549095, 0.07969033718109131, -0.07410696148872375, 0.056982796639204025, 0.11321980506181717, -0.01095123216509819, 0.025400491431355476, -0.05580538138747215, 0.012483312748372555, -0.011376961134374142, -0.0068026878871023655, 0.004903411027044058, 0.015429849736392498, 0.049535300582647324, -0.039502568542957306, -0.04969986528158188, -0.010050683282315731, -0.01933238096535206, -0.021974463015794754, -0.11043483763933182, -0.06486939638853073, 0.06382288783788681, 0.06134537607431412, 0.006464947015047073, -0.07057620584964752, -0.019604666158556938, 0.04850337654352188, 0.07953473925590515, -0.13069778680801392, -0.08097472786903381, -0.035139989107847214, -0.09215270727872849, 0.004090290050953627, 0.07554320245981216, 0.11321456730365753, -0.020489415153861046, -0.004201000090688467, 0.03860342130064964, 0.0529588982462883, 0.04659923538565636, 0.01077478751540184, -0.0702141523361206, -0.033120278269052505, -0.0030482683796435595, -0.010406751185655594, -0.04371554031968117, 0.02922447770833969, -0.0257999449968338, 0.03400520980358124, -0.006668788380920887, 0.042731113731861115, -0.07517815381288528, -0.019018203020095825, -0.1864369660615921, -0.0712374672293663, -0.06218991428613663, -0.01968321204185486, -0.00255231698974967, -0.01879379153251648, -0.004883213900029659, 0.010086589492857456],
          20, -- top_k
          16  -- ef_search: quality of search
  		)
ORDER BY distance
;
							 


-- Drop and recreate the table
DROP TABLE IF EXISTS flights;

-- Create the fact table
CREATE FACT TABLE flights (
    year INTEGER,
    month INTEGER,
    day INTEGER,
    day_of_week INTEGER,
    fl_date DATE,
    carrier_code TEXT,
    tail_num TEXT,
    fl_num TEXT,
    origin_airport_code TEXT,
    dest_airport_code TEXT,
    crs_dep_time INTEGER,
    dep_time DOUBLE,
    dep_delay DOUBLE,
    taxi_out DOUBLE,
    wheels_off DOUBLE,
    wheels_on DOUBLE,
    taxi_in DOUBLE,
    crs_arr_time DOUBLE,
    arr_time DOUBLE,
    arr_delay DOUBLE,
    cancelled DOUBLE,
    cancellation_code TEXT,
    diverted DOUBLE,
    crs_elapsed_time DOUBLE,
    actual_elapsed_time DOUBLE,
    air_time DOUBLE,
    distance DOUBLE,
    carrier_delay DOUBLE,
    weather_delay DOUBLE,
    nas_delay DOUBLE,
    security_delay DOUBLE,
    late_aircraft_delay DOUBLE
) PRIMARY INDEX fl_date;


INSERT INTO flights
SELECT * FROM READ_CSV('s3://firebolt-publishing-public/bts/bts.flights.csv'); 

-- Drop existing table if needed
DROP TABLE IF EXISTS airlines;

-- Create the dimension table
CREATE DIMENSION TABLE airlines (
    carrier_code TEXT,
    airline TEXT
) PRIMARY INDEX carrier_code;

-- Load the data (no header row to skip)
COPY INTO airlines
FROM 's3://firebolt-publishing-public/bts/bts.airlines.csv'
WITH 
    TYPE = CSV;


-- Prompt: By using the S3 URL 's3://firebolt-publishing-public/bts/bts.airports.csv' which does not contain headers, analyze the data to determine data types, then create a dimension table that has columns airport_code, airport, city, state, country, latitude, longitude and load the data.
-- Drop existing table if needed
DROP TABLE IF EXISTS airports;

-- Create the dimension table
CREATE DIMENSION TABLE airports (
    airport_code TEXT,
    airport TEXT,
    city TEXT,
    state TEXT,
    country TEXT,
    latitude DOUBLE,
    longitude DOUBLE
) PRIMARY INDEX airport_code;

-- Load the data (no header row to skip)
COPY INTO airports
FROM 's3://firebolt-publishing-public/bts/bts.airports.csv'
WITH 
    TYPE = CSV;

